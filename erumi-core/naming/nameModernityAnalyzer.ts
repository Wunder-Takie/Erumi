/**
 * nameModernityAnalyzer.ts
 * 로컬 기반 이름 현대성/어색함 분석 시스템
 * 
 * 1단계: 패턴 분석 (돌림자, 어색한 발음, 세대별 조합)
 * 2단계: 통계 분석 (연도별 인기 이름)
 */

// ============================================
// Types
// ============================================

export interface ModernityAnalysis {
    score: number;           // 1-10 (10이 가장 현대적)
    isOldFashioned: boolean;
    isAwkward: boolean;
    reasons: string[];
    penalty: number;         // 감점할 점수
}

// ============================================
// 1단계: 위치별 음절 점수 시스템 (고도화)
// - 양수: 트렌디, 음수: 올드, 0: 중립
// - 한자 DB 72개 음절 전체 커버
// ============================================

// 첫 번째 음절 점수 (이름의 첫 글자)
const FIRST_SYLLABLE_SCORE: Record<string, number> = {
    // === 강한 트렌디 (+3) ===
    '서': 3, '하': 3, '시': 3, '이': 3,

    // === 트렌디 (+2) ===
    '도': 2, '지': 2, '유': 2, '온': 2, '로': 2,
    '채': 2, '소': 2, '나': 2,

    // === 약한 트렌디 (+1) ===
    '수': 1, '예': 1, '라': 1, '리': 1, '린': 1,
    '태': 1, '준': 1, '우': 1, '윤': 1, '은': 1,

    // === 중립 (0) ===
    '건': 0, '결': 0, '겸': 0, '광': 0, '규': 0,
    '단': 0, '랑': 0, '미': 0, '비': 0, '빈': 0,
    '석': 0, '선': 0, '성': 0, '솔': 0, '안': 0,
    '애': 0, '연': 0, '엽': 0, '완': 0, '원': 0,
    '율': 0, '의': 0, '인': 0, '일': 0, '재': 0,
    '찬': 0, '창': 0, '천': 0, '택': 0, '평': 0,
    '한': 0, '혁': 0, '형': 0, '혜': 0, '화': 0, '환': 0, '훈': 0,

    // === 약한 올드 (-1) ===
    '민': -1, '현': -1, '진': -1,

    // === 올드 (-2) ===
    '영': -2, '경': -2, '정': -2,

    // === 강한 올드 (-3) ===
    '철': -3, '근': -3, '희': -3, '자': -3, '호': -3,
};

// 두 번째 음절 점수 (이름의 끝 글자) - 끝자리가 느낌에 더 큰 영향
const SECOND_SYLLABLE_SCORE: Record<string, number> = {
    // === 강한 트렌디 (+4) ===
    '아': 4, '온': 4, '율': 4, '린': 4,

    // === 트렌디 (+3) ===
    '윤': 3, '우': 3, '안': 3, '은': 3, '서': 3,
    '유': 3, '준': 3, '운': 3,

    // === 약한 트렌디 (+2) ===
    '빈': 2, '원': 2, '연': 2, '나': 2, '진': 2,
    '현': 2, '민': 2, '호': 2,  // 현, 민, 호는 끝자리에서는 중립~트렌디

    // === 중립 (+1) ===
    '하': 1, '결': 1, '겸': 1, '광': 1, '규': 1,
    '라': 1, '랑': 1, '로': 1, '리': 1, '미': 1,
    '비': 1, '솔': 1, '애': 1, '엽': 1, '완': 1,
    '의': 1, '인': 1, '일': 1, '재': 1, '찬': 1,
    '창': 1, '채': 1, '천': 1, '택': 1, '평': 1,
    '한': 1, '혁': 1, '형': 1, '혜': 1, '화': 1, '환': 1, '훈': 1,

    // === 중립 (0) ===
    '건': 0, '단': 0, '도': 0, '석': 0, '선': 0,
    '성': 0, '소': 0, '시': 0, '예': 0, '이': 0, '태': 0,

    // === 약한 올드 (-1) ===
    '근': -1, '지': -1,  // 지는 끝자리에서 올드

    // === 올드 (-2) ===
    '영': -2, '경': -2, '정': -2, '주': -2,

    // === 강한 올드 (-3) ===
    '수': -3, '철': -3, '희': -3, '자': -3, '숙': -3,
};

// 음절 점수 계산 함수 (🆕 export 추가)
export function getSyllableScore(char1: string, char2: string): number {
    const score1 = FIRST_SYLLABLE_SCORE[char1] ?? 0;
    const score2 = SECOND_SYLLABLE_SCORE[char2] ?? 0;
    return score1 + score2;
}

// 올드한 조합 (첫글자 + 끝글자)
const OLD_COMBINATIONS = new Set([
    // 남자
    '영수', '영호', '영민', '영철', '영진', '영석',
    '철수', '철호', '철민',
    '민수', '민호', '민철', '민석',
    '진수', '진호', '진석', '진철',
    '성수', '성호', '성민', '성철',
    '준수', '준호', '준석', '준철',
    '현수', '현호', '현석', '현철',
    '찬수', '찬호', '찬석', '찬철',
    '유성', // 유성우
    // 여자
    '영희', '영자', '영순', '영숙', '영미', '영주',
    '순자', '순희', '순옥',
    '미자', '미순', '미옥', '미숙', '미영',
    '경자', '경희', '경순', '경숙', '경미',
    '정자', '정희', '정순', '정숙', '정미',
    '선자', '선희', '선옥',
    '현자', '현희', '현주', '현숙',
    '지영', '지현', '지연', '지원', // 90년대 느낌
    '민영', '민주', '민희', '민정',
    '수진', '수연', '수현', '수민',
    // 추가: 올드하거나 중립적이지만 부모님 세대 느낌
    '경서', '서지', // 중립적이지만 부모님 세대
]);

// ============================================
// 어색한 발음/동음이의어 패턴
// ============================================

// 다른 단어와 혼동되는 이름
const AWKWARD_HOMOPHONE_NAMES = new Map<string, string>([
    ['시민', '시민권, 시민단체'],
    ['채소', '야채'],
    ['환아', '환자의 아이 (患兒)'],
    ['연소', '불에 타다 (燃燒)'],
    ['연지', '연지곤지 화장'],
    ['현예', '현예하다 (玄藝)'],
    ['혜아', '해아로 들림'],
    ['수예', '수예품'],
    ['하유', '하유? (질문으로 들림)'],
    ['유하', '유하다 (형용사)'],
    ['채지', '채지하다'],
    ['진예', '진예하다'],
    ['경지', '경지에 이르다'],
    ['윤결', '윤결됨'],
    ['민수', '민수(民數) 성경책'],
    // 추가: 어색한 이름들
    ['도서', '도서관, 도서 대출'],
    ['시유', '시유버터, 시유우유'],
    ['유성', '유성우, 유성매직'],
    ['진유', '진유하다'],
    ['유지', '유지하다, 유지비'],
    ['하나', '하나은행, 숫자 1'],
    ['나라', '나라이름'],
    ['보라', '보라색'],
]);

// 발음하기 어색한 조합
const AWKWARD_PHONETIC_PATTERNS = [
    // ㅎ + ㅇ 연음으로 어색해지는 경우
    /혜[아이우에오]/,
    /희[아이우에오]/,
    // 같은 모음 반복
    /[아야어여오요우유으이]{2}/,
];

// ============================================
// 2단계: 통계 데이터 (연도별 인기 이름)
// ============================================

// 1970-80년대 인기 이름 (올드 판정)
const POPULAR_1970_80 = new Set([
    // 남자
    '영수', '철수', '영호', '성호', '민수', '진수', '영철', '정수',
    '상수', '동수', '광수', '명수', '용수', '재수', '경수', '태수',
    '영민', '성민', '진호', '용호', '준호', '성호', '철호', '상호',
    // 여자
    '영희', '순자', '영자', '정자', '미자', '경자', '경희', '미숙',
    '정희', '영숙', '순희', '미영', '경미', '정미', '선희', '명희',
    '영순', '미순', '경순', '은희', '은자', '은숙', '현숙', '진숙',
]);

// 1990년대 인기 이름 (약간 올드)
const POPULAR_1990 = new Set([
    // 남자
    '지훈', '성민', '동현', '지호', '현우', '민수', '민호', '준혁',
    '승현', '현석', '태현', '정훈', '민석', '성훈', '정현', '재현',
    // 여자
    '지영', '수진', '지현', '민지', '지은', '혜진', '은지', '소영',
    '유진', '지연', '수현', '민영', '혜영', '은영', '지원', '수연',
    '현정', '은정', '지선', '민정', '혜정', '소연', '미연', '유경',
]);

// 2023-2025년 트렌디한 이름 (보너스) - 사용자 선별 목록
const TRENDY_2020 = new Set([
    // 남자 (2023-2025 인기)
    '이준', '서준', '시우', '도윤', '하준', '지호', '유준', '선우',
    '지안', '태윤', '서우', '은우', '로운', '온유', '하율', '준우',
    '이서', '시안', '준서', '이안', '수호', '도준', '유빈', '시현', '시원',
    // 여자 (2023-2025 인기)
    '서윤', '서아', '지유', '하윤', '하은', '채윤', '수아', '윤서',
    '서연', '다온', '소율', '다은', '시은', '소은', '유나', '예서',
    '하린', '소윤', '다인', '지민', '유진', '소연', '아윤', '지윤', '민서',
    '지원', '채아', '나윤', '민아', '세아', '서율', '아린', '예나',
    '시아', '서현', '수연', '도연', '채린',
]);

// ============================================
// 분석 함수
// ============================================

/**
 * 이름의 현대성/어색함을 종합 분석
 */
export function analyzeNameModernity(name: string): ModernityAnalysis {
    const reasons: string[] = [];
    let score = 7; // 기본 점수 (중립적)
    let penalty = 0;

    // 이름이 2글자인 경우 분리
    const char1 = name.charAt(0);
    const char2 = name.length > 1 ? name.charAt(1) : '';

    // =====================================
    // 1단계: 음절 점수 분석 (신규 통합 시스템)
    // =====================================

    // 1-1. 위치별 음절 점수 계산
    const syllableScore = getSyllableScore(char1, char2);

    if (syllableScore >= 5) {
        // 매우 트렌디
        score += 2;
        penalty -= 25;
        reasons.push(`'${char1}+${char2}' 조합은 매우 트렌디 (점수: ${syllableScore})`);
    } else if (syllableScore >= 2) {
        // 트렌디
        score += 1;
        penalty -= 15;
        reasons.push(`'${char1}+${char2}' 조합은 트렌디 (점수: ${syllableScore})`);
    } else if (syllableScore <= -4) {
        // 매우 올드
        score -= 3;
        penalty += 40;
        reasons.push(`'${char1}+${char2}' 조합은 매우 올드 (점수: ${syllableScore})`);
    } else if (syllableScore <= -2) {
        // 올드
        score -= 2;
        penalty += 25;
        reasons.push(`'${char1}+${char2}' 조합은 올드 (점수: ${syllableScore})`);
    }
    // syllableScore가 -1 ~ +1 이면 중립 (변화 없음)

    // 1-2. 올드한 조합 목록 (추가 페널티 - 목록에 명시된 경우)
    if (OLD_COMBINATIONS.has(name)) {
        score -= 2;
        penalty += 20;
        reasons.push(`'${name}'는 70-90년대에 흔했던 이름`);
    }

    // 1-3. 어색한 동음이의어 (블랙리스트)
    if (AWKWARD_HOMOPHONE_NAMES.has(name)) {
        score -= 3;
        penalty += 45;
        reasons.push(`'${name}'는 '${AWKWARD_HOMOPHONE_NAMES.get(name)}'와 혼동됨`);
    }

    // 1-4. 어색한 발음 패턴
    for (const pattern of AWKWARD_PHONETIC_PATTERNS) {
        if (pattern.test(name)) {
            score -= 2;
            penalty += 25;
            reasons.push('발음이 어색한 조합');
            break;
        }
    }

    // =====================================
    // 2단계: 통계 분석
    // =====================================

    // 2-1. 70-80년대 인기 이름
    if (POPULAR_1970_80.has(name)) {
        score -= 4;
        penalty += 50;
        reasons.push(`'${name}'는 1970-80년대 인기 이름`);
    }

    // 2-2. 90년대 인기 이름 (덜 강한 페널티)
    else if (POPULAR_1990.has(name)) {
        score -= 2;
        penalty += 20;
        reasons.push(`'${name}'는 1990년대 인기 이름`);
    }

    // 2-3. 2020년대 트렌디 (보너스)
    if (TRENDY_2020.has(name)) {
        score += 2;
        penalty -= 20; // 마이너스 페널티 (보너스)
        reasons.push(`'${name}'는 2020년대 트렌디한 이름`);
    }

    // =====================================
    // 최종 계산
    // =====================================

    // 점수 범위 제한
    score = Math.max(1, Math.min(10, score));
    penalty = Math.max(0, penalty); // 보너스로 음수가 될 수 있지만 최소 0

    return {
        score: Math.round(score * 10) / 10,
        isOldFashioned: score <= 4 || POPULAR_1970_80.has(name) || OLD_COMBINATIONS.has(name),
        isAwkward: AWKWARD_HOMOPHONE_NAMES.has(name),
        reasons,
        penalty,
    };
}

/**
 * 이름이 필터링 대상인지 확인 (상위권에서 제외할지)
 */
export function shouldFilterName(name: string): boolean {
    const analysis = analyzeNameModernity(name);
    return analysis.isOldFashioned || analysis.isAwkward || analysis.penalty >= 30;
}

/**
 * 페널티 점수만 빠르게 계산
 */
export function getModernityPenalty(name: string): number {
    return analyzeNameModernity(name).penalty;
}

/**
 * 🆕 v6.0: 트렌디 이름 보너스 계산 (1000점 시스템용)
 * 음절 점수 기반으로 트렌디한 이름에 보너스 부여
 */
export function getModernityBonus(name: string): number {
    const char1 = name.charAt(0);
    const char2 = name.charAt(1) || '';
    const syllableScore = getSyllableScore(char1, char2);

    if (syllableScore >= 5) return 80;   // 매우 트렌디 (서윤, 하린 등)
    if (syllableScore >= 2) return 50;   // 트렌디 (지아, 도윤 등)
    if (syllableScore >= 0) return 20;   // 중립
    return 0;  // 올드 (보너스 없음)
}

export default {
    analyzeNameModernity,
    shouldFilterName,
    getModernityPenalty,
    getModernityBonus,
    getSyllableScore,
};
